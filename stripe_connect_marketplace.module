<?php

/**
 * @file
 * Contains stripe_connect_marketplace.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Access\AccessResult;
use Drupal\stripe_connect_marketplace\Utility\SafeLogging;

/**
 * Implements hook_help().
 */
function stripe_connect_marketplace_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.stripe_connect_marketplace':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Stripe Connect Marketplace module integrates Drupal Commerce with Stripe Connect to create a multi-vendor marketplace.') . '</p>';
      $output .= '<p>' . t('Configuration:') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('<a href=":settings">Configure Stripe Connect settings</a>', [':settings' => Url::fromRoute('stripe_connect_marketplace.settings')->toString()]) . '</li>';
      $output .= '<li>' . t('<a href=":dashboard">View Stripe Connect dashboard</a>', [':dashboard' => Url::fromRoute('stripe_connect_marketplace.admin_dashboard')->toString()]) . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function stripe_connect_marketplace_theme($existing, $type, $theme, $path) {
  return [
    'stripe_connect_admin_dashboard' => [
      'variables' => [
        'vendors' => NULL,
        'balance' => NULL,
        'payouts' => NULL,
        'environment' => NULL,
      ],
      'template' => 'stripe-connect-admin-dashboard',
    ],
    'stripe_connect_onboarding_complete' => [
      'variables' => [
        'account' => NULL,
        'user' => NULL,
      ],
      'template' => 'stripe-connect-onboarding-complete',
    ],
    'stripe_connect_vendor_dashboard' => [
      'variables' => [
        'account' => NULL,
        'balance' => NULL,
        'payouts' => NULL,
        'user' => NULL,
      ],
      'template' => 'stripe-connect-vendor-dashboard',
    ],
    'stripe_connect_vendor_details' => [
      'variables' => [
        'vendor' => [],
        'account' => [],
        'balance' => [],
        'payouts' => [],
      ],
      'template' => 'stripe-connect-vendor-details',
    ],
    'stripe_connect_vendor_payouts' => [
      'variables' => [
        'vendor' => [],
        'payouts' => [],
      ],
      'template' => 'stripe-connect-vendor-payouts',
    ],
    'stripe_connect_vendor_terms' => [
      'variables' => [
        'terms' => [],
      ],
      'template' => 'stripe-connect-vendor-terms',
    ],
    'vendor_action_buttons' => [
      'variables' => [
        'buttons' => [],
      ],
      'template' => 'vendor-action-buttons',
    ],
  ];
}

/**
 * Implements hook_entity_operation().
 */
function stripe_connect_marketplace_entity_operation(EntityInterface $entity) {
  $operations = [];
  
  // Add operations for user entities
  if ($entity->getEntityTypeId() === 'user') {
    $account = \Drupal::currentUser();
    
    // Add "Make vendor" link for users without vendor role
    if ($account->hasPermission('administer stripe connect') && 
        !$entity->hasRole('vendor') && 
        $entity->id() != 1) { // Skip anonymous user
      
      $operations['make_vendor'] = [
        'title' => t('Make vendor'),
        'weight' => 50,
        'url' => Url::fromRoute('stripe_connect_marketplace.make_vendor', ['user' => $entity->id()]),
      ];
    }
    
    // Add operations for user entities that are vendors with Stripe accounts
    if ($entity->hasField('field_stripe_account_id') && 
        !$entity->get('field_stripe_account_id')->isEmpty()) {
      
      $operations['stripe_connect'] = [
        'title' => t('Stripe Connect'),
        'weight' => 51,
        'url' => Url::fromRoute('stripe_connect_marketplace.view_vendor', ['user' => $entity->id()]),
      ];
    }
  }
  
  return $operations;
}

/**
 * Implements hook_entity_access().
 */
function stripe_connect_marketplace_entity_access(EntityInterface $entity, $operation, AccountInterface $account) {
  // Only apply vendor restrictions to appropriate entity types
  if ($account->hasRole('vendor')) {
    $vendor_access = \Drupal::service('stripe_connect_marketplace.vendor_access');

    if ($entity->getEntityTypeId() === 'commerce_store') {
      return $vendor_access->storeAccess($entity, $operation, $account);
    }
    elseif ($entity->getEntityTypeId() === 'commerce_product') {
      return $vendor_access->productAccess($entity, $operation, $account);
    }
    elseif ($entity->getEntityTypeId() === 'commerce_order') {
      return $vendor_access->orderAccess($entity, $operation, $account);
    }
  }
  
  return AccessResult::neutral();
}

/**
 * Implements hook_commerce_store_presave().
 */
function stripe_connect_marketplace_commerce_store_presave(EntityInterface $entity) {
  // For new stores created by vendors, set current user as owner if not already set
  if ($entity->isNew() && empty($entity->getOwnerId())) {
    $current_user = \Drupal::currentUser();
    if ($current_user->hasRole('vendor')) {
      $entity->setOwnerId($current_user->id());
      
      \Drupal::logger('stripe_connect_marketplace')->notice('Automatically set vendor @uid as owner of new store @sid', [
        '@uid' => $current_user->id(),
        '@sid' => $entity->id() ?? 'new',
      ]);
    }
  }
}

/**
 * Implements hook_form_alter().
 */
function stripe_connect_marketplace_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $current_user = \Drupal::currentUser();
  
  // Modify store form for vendors
  if ($form_id === 'commerce_store_form' && $current_user->hasRole('vendor')) {
    // Hide the owner field - vendors can only create stores they own
    if (isset($form['uid'])) {
      $form['uid']['#access'] = FALSE;
      
      // Set the current user as the owner
      $form['uid']['widget'][0]['target_id']['#default_value'] = $current_user;
    }
  }
  
  // Modify product form for vendors
  if (str_starts_with($form_id, 'commerce_product_') && str_ends_with($form_id, '_form') && $current_user->hasRole('vendor')) {
    // Limit store selection to vendor's own stores
    if (isset($form['stores']['widget'])) {
      $vendor_access = \Drupal::service('stripe_connect_marketplace.vendor_access');
      $user_store_ids = $vendor_access->getUserStoreIds($current_user->id());
      
      // If user has stores, limit the options
      if (!empty($user_store_ids)) {
        $store_options = $form['stores']['widget']['#options'];
        
        // Filter options to only include user's stores
        foreach ($store_options as $key => $option) {
          if ($key === '_none') {
            continue;
          }
          
          // Extract store ID from option key (format: "entity:commerce_store/1")
          $parts = explode('/', $key);
          $store_id = end($parts);
          
          if (!in_array($store_id, $user_store_ids)) {
            unset($form['stores']['widget']['#options'][$key]);
          }
        }
      }
    }
  }
}

/**
 * Implements hook_toolbar().
 */
function stripe_connect_marketplace_toolbar() {
  $items = [];
  
  // Check for vendor role if this is the front-end
  $current_user = \Drupal::currentUser();
  if ($current_user->hasPermission('view stripe connect dashboard')) {
    $items['stripe_connect_vendor'] = [
      '#type' => 'toolbar_item',
      '#weight' => 999,
      'tab' => [
        '#type' => 'link',
        '#title' => t('Vendor Dashboard'),
        '#url' => Url::fromRoute('stripe_connect_marketplace.vendor_dashboard'),
        '#attributes' => [
          'title' => t('Stripe Connect Vendor Dashboard'),
          'class' => ['toolbar-icon', 'toolbar-icon-stripe-connect-vendor'],
        ],
      ],
    ];
  }
  
  // Check for admin role
  if ($current_user->hasPermission('access stripe connect admin')) {
    $items['stripe_connect_admin'] = [
      '#type' => 'toolbar_item',
      '#weight' => 999,
      'tab' => [
        '#type' => 'link',
        '#title' => t('Stripe Connect Admin'),
        '#url' => Url::fromRoute('stripe_connect_marketplace.admin_dashboard'),
        '#attributes' => [
          'title' => t('Stripe Connect Admin Dashboard'),
          'class' => ['toolbar-icon', 'toolbar-icon-stripe-connect-admin'],
        ],
      ],
    ];
  }
  
  return $items;
}

/**
 * Implements hook_cron().
 */
function stripe_connect_marketplace_cron() {
  // Verify API keys every 6 hours
  $api_key_interval = 21600; // 6 hours
  $last_key_verification = \Drupal::state()->get('stripe_connect_marketplace.last_api_verification', 0);
  
  if (time() - $last_key_verification >= $api_key_interval) {
    try {
      // Verify the API keys
      $verification_service = \Drupal::service('stripe_connect_marketplace.api_key_verification');
      $verification_service->verifyApiKeys();
      
      // Update last verification time
      \Drupal::state()->set('stripe_connect_marketplace.last_api_verification', time());
    }
    catch (\Exception $e) {
      \Drupal::logger('stripe_connect_marketplace')->error('Error during API key verification: @message', [
        '@message' => $e->getMessage(),
      ]);
    }
  }
  
  // Verify connected accounts every 12 hours (process 20 at a time)
  $account_interval = 43200; // 12 hours
  $last_account_verification = \Drupal::state()->get('stripe_connect_marketplace.last_account_verification', 0);
  
  if (time() - $last_account_verification >= $account_interval) {
    try {
      // Verify connected accounts
      $account_service = \Drupal::service('stripe_connect_marketplace.account_verification');
      $stats = $account_service->verifyVendorAccounts(20);
      
      // Log the results
      if ($stats['checked'] > 0) {
        \Drupal::logger('stripe_connect_marketplace')->info('Verified @checked vendor accounts: @updated updated, @deleted marked as deleted', [
          '@checked' => $stats['checked'],
          '@updated' => $stats['updated'],
          '@deleted' => $stats['deleted'],
        ]);
      }
      
      // Update last verification time
      \Drupal::state()->set('stripe_connect_marketplace.last_account_verification', time());
    }
    catch (\Exception $e) {
      \Drupal::logger('stripe_connect_marketplace')->error('Error during account verification: @message', [
        '@message' => $e->getMessage(),
      ]);
    }
  }
  
  // Process failed operations queue
  $queue_processor_interval = 1800; // 30 minutes
  $last_queue_processing = \Drupal::state()->get('stripe_connect_marketplace.last_queue_processing', 0);
  
  if (time() - $last_queue_processing >= $queue_processor_interval) {
    try {
      // Process the failed operations queue
      $failed_operations = \Drupal::service('stripe_connect_marketplace.failed_operations');
      $stats = $failed_operations->processQueue(10);
      
      // Log the results if anything was processed
      if ($stats['processed'] > 0) {
        \Drupal::logger('stripe_connect_marketplace')->info('Processed @processed failed operations: @succeeded succeeded, @requeued requeued, @dropped dropped', [
          '@processed' => $stats['processed'],
          '@succeeded' => $stats['succeeded'],
          '@requeued' => $stats['requeued'],
          '@dropped' => $stats['dropped'],
        ]);
      }
      
      // Update last processing time
      \Drupal::state()->set('stripe_connect_marketplace.last_queue_processing', time());
    }
    catch (\Exception $e) {
      \Drupal::logger('stripe_connect_marketplace')->error('Error processing failed operations queue: @message', [
        '@message' => $e->getMessage(),
      ]);
    }
  }
}

/**
 * Implements hook_mail().
 */
function stripe_connect_marketplace_mail($key, &$message, $params) {
  switch ($key) {
    case 'api_key_failure':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['message'];
      break;
      
    case 'account_deleted':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['message'];
      break;
      
    case 'vendor_status_change':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['message'];
      break;
  }
}

/**
 * Safe logging helper function for hooks and other non-class code.
 * 
 * @param string $message
 *   The message to log.
 * @param array $variables
 *   The variables for the message.
 * @param string $level
 *   The log level (error, warning, notice, info).
 */
function stripe_connect_marketplace_log($message, array $variables = [], $level = 'error') {
  // Use the utility class for logging if available
  if (class_exists('\Drupal\stripe_connect_marketplace\Utility\SafeLogging')) {
    SafeLogging::moduleLog($message, $variables, $level);
    return;
  }
  
  // Fallback if utility class isn't available
  $logger = \Drupal::logger('stripe_connect_marketplace');
  
  // Basic sanitization
  foreach ($variables as $key => $value) {
    if ($value === NULL) {
      $variables[$key] = '(null)';
    }
    elseif (is_object($value) && !method_exists($value, '__toString')) {
      $variables[$key] = get_class($value) . ' object';
    }
    elseif (is_array($value)) {
      $variables[$key] = 'Array';
    }
  }
  
  // Log with the appropriate level
  switch ($level) {
    case 'warning':
      $logger->warning($message, $variables);
      break;
    
    case 'notice':
      $logger->notice($message, $variables);
      break;
    
    case 'info':
      $logger->info($message, $variables);
      break;
    
    case 'error':
    default:
      $logger->error($message, $variables);
      break;
  }
}

/**
 * Implements hook_menu_links_discovered_alter().
 */
function stripe_connect_marketplace_menu_links_discovered_alter(&$links) {
  // Add access control for vendor menu items
  if (isset($links['stripe_connect_marketplace.vendor_menu'])) {
    $links['stripe_connect_marketplace.vendor_menu']['access_callback'] = '_stripe_connect_marketplace_vendor_menu_access';
  }
  
  if (isset($links['stripe_connect_marketplace.vendor_stores'])) {
    $links['stripe_connect_marketplace.vendor_stores']['access_callback'] = '_stripe_connect_marketplace_vendor_menu_access';
  }
  
  if (isset($links['stripe_connect_marketplace.vendor_products'])) {
    $links['stripe_connect_marketplace.vendor_products']['access_callback'] = '_stripe_connect_marketplace_vendor_menu_access';
  }
  
  if (isset($links['stripe_connect_marketplace.vendor_orders'])) {
    $links['stripe_connect_marketplace.vendor_orders']['access_callback'] = '_stripe_connect_marketplace_vendor_menu_access';
  }
}

/**
 * Access callback for vendor menu items.
 *
 * @return bool
 *   TRUE if the user should see the vendor menu items, FALSE otherwise.
 */
function _stripe_connect_marketplace_vendor_menu_access() {
  $user = \Drupal::currentUser();
  return $user->hasPermission('access vendor menu') || $user->hasPermission('view stripe connect dashboard');
}

/**
 * Implements hook_preprocess_menu().
 */
function stripe_connect_marketplace_preprocess_menu(&$variables) {
  // Handle vendor access to main menu items based on roles/permissions
  if (isset($variables['menu_name']) && $variables['menu_name'] == 'main') {
    $user = \Drupal::currentUser();
    
    // Show vendor menu items only to vendors or admins
    $is_vendor = $user->hasRole('vendor');
    $is_admin = $user->hasPermission('administer stripe connect');
    
    if (!$is_vendor && !$is_admin) {
      // Remove vendor menu items for non-vendors
      if (isset($variables['items']['stripe_connect_marketplace.vendor_menu'])) {
        unset($variables['items']['stripe_connect_marketplace.vendor_menu']);
      }
    }
  }
}

/**
 * Implements hook_toolbar_alter().
 */
function stripe_connect_marketplace_toolbar_alter(&$items) {
  // Get current user
  $user = \Drupal::currentUser();
  
  // Add a vendor dashboard link to the toolbar for vendors
  if ($user->hasRole('vendor') && $user->hasPermission('view stripe connect dashboard')) {
    $items['vendor_dashboard'] = [
      '#type' => 'toolbar_item',
      '#weight' => 999,
      'tab' => [
        '#type' => 'link',
        '#title' => t('Vendor Dashboard'),
        '#url' => \Drupal\Core\Url::fromRoute('stripe_connect_marketplace.vendor_dashboard'),
        '#attributes' => [
          'title' => t('Stripe Connect Vendor Dashboard'),
          'class' => ['toolbar-icon', 'toolbar-icon-stripe-connect-vendor'],
        ],
      ],
    ];
  }
}

/**
 * Implements hook_theme().
 * 
 * This adds a custom container for vendor navigation.
 */
function stripe_connect_marketplace_theme_registry_alter(&$theme_registry) {
  // Add a preprocess function for page to add vendor sidebar
  if (isset($theme_registry['page'])) {
    $theme_registry['page']['preprocess functions'][] = 'stripe_connect_marketplace_preprocess_page';
  }
}

/**
 * Implements template_preprocess_page().
 */
function stripe_connect_marketplace_preprocess_page(&$variables) {
  $user = \Drupal::currentUser();
  
  // Add vendor sidebar for vendors
  if ($user->hasRole('vendor')) {
    $variables['vendor_sidebar'] = [
      '#theme' => 'item_list',
      '#title' => t('Vendor Menu'),
      '#items' => [
        [
          '#type' => 'link',
          '#title' => t('Dashboard'),
          '#url' => \Drupal\Core\Url::fromRoute('stripe_connect_marketplace.vendor_dashboard'),
          '#attributes' => ['class' => ['vendor-nav-item', 'vendor-dashboard']],
        ],
        [
          '#type' => 'link',
          '#title' => t('Stripe Dashboard'),
          '#url' => \Drupal\Core\Url::fromRoute('stripe_connect_marketplace.stripe_dashboard_redirect'),
          '#attributes' => [
            'class' => ['vendor-nav-item', 'stripe-dashboard'],
            'target' => '_blank',
          ],
        ],
        [
          '#type' => 'link',
          '#title' => t('My Stores'),
          '#url' => \Drupal\Core\Url::fromRoute('entity.commerce_store.collection'),
          '#attributes' => ['class' => ['vendor-nav-item', 'vendor-stores']],
        ],
        [
          '#type' => 'link',
          '#title' => t('My Products'),
          '#url' => \Drupal\Core\Url::fromRoute('entity.commerce_product.collection'),
          '#attributes' => ['class' => ['vendor-nav-item', 'vendor-products']],
        ],
        [
          '#type' => 'link',
          '#title' => t('My Orders'),
          '#url' => \Drupal\Core\Url::fromRoute('entity.commerce_order.collection'),
          '#attributes' => ['class' => ['vendor-nav-item', 'vendor-orders']],
        ],
      ],
      '#attributes' => ['class' => ['vendor-sidebar-nav']],
    ];
    
    // Attach vendor sidebar CSS
    $variables['#attached']['library'][] = 'stripe_connect_marketplace/vendor_sidebar';
  }
}

/**
 * Implements hook_page_attachments().
 */
function stripe_connect_marketplace_page_attachments(array &$attachments) {
  $route_name = \Drupal::routeMatch()->getRouteName();
  
  // Only attach to vendor dashboard routes
  if (strpos($route_name, 'stripe_connect_marketplace.vendor') === 0) {
    $attachments['#attached']['library'][] = 'stripe_connect_marketplace/vendor_dashboard';
  }
}

/**
 * Implements hook_menu_alter().
 */
function stripe_connect_marketplace_menu_alter(&$items) {
  // Override access callbacks for store-related routes to allow vendor access
  if (isset($items['entity.commerce_store.collection'])) {
    $items['entity.commerce_store.collection']['access callback'] = '_stripe_connect_marketplace_vendor_store_collection_access';
    $items['entity.commerce_store.collection']['access arguments'] = ['view own commerce_store'];
  }
  
  // Override store edit route access
  if (isset($items['entity.commerce_store.edit_form'])) {
    $items['entity.commerce_store.edit_form']['access callback'] = '_stripe_connect_marketplace_vendor_store_entity_access';
    $items['entity.commerce_store.edit_form']['access arguments'] = [1, 'update'];
  }
  
  // Override product-related route access
  if (isset($items['entity.commerce_product.collection'])) {
    $items['entity.commerce_product.collection']['access callback'] = '_stripe_connect_marketplace_vendor_product_collection_access';
    $items['entity.commerce_product.collection']['access arguments'] = ['view own commerce_product'];
  }
  
  // Override product edit route access
  if (isset($items['entity.commerce_product.edit_form'])) {
    $items['entity.commerce_product.edit_form']['access callback'] = '_stripe_connect_marketplace_vendor_product_entity_access';
    $items['entity.commerce_product.edit_form']['access arguments'] = [1, 'update'];
  }
  
  // Override order collection route access
  if (isset($items['entity.commerce_order.collection'])) {
    $items['entity.commerce_order.collection']['access callback'] = '_stripe_connect_marketplace_vendor_order_collection_access';
    $items['entity.commerce_order.collection']['access arguments'] = ['view own commerce_order'];
  }
  
  // Allow vendor access to add store form
  if (isset($items['entity.commerce_store.add_form'])) {
    $items['entity.commerce_store.add_form']['access callback'] = '_stripe_connect_marketplace_vendor_add_store_access';
  }
  
  // Allow vendor access to add product form
  if (isset($items['entity.commerce_product.add_form'])) {
    $items['entity.commerce_product.add_form']['access callback'] = '_stripe_connect_marketplace_vendor_add_product_access';
  }
}

/**
 * Access callback for vendor store collection.
 */
function _stripe_connect_marketplace_vendor_store_collection_access($permission = NULL) {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_store')) {
    return TRUE;
  }
  
  // Allow access for vendors with appropriate permission
  if ($account->hasRole('vendor') && ($permission === NULL || $account->hasPermission($permission))) {
    return TRUE;
  }
  
  return FALSE;
}

/**
 * Access callback for vendor store entity operations.
 */
function _stripe_connect_marketplace_vendor_store_entity_access($store, $operation = 'view') {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_store')) {
    return TRUE;
  }
  
  // Allow access for vendor if they own the store
  if ($account->hasRole('vendor') && $account->hasPermission($operation . ' own commerce_store')) {
    return $store->getOwnerId() == $account->id();
  }
  
  return FALSE;
}

/**
 * Access callback for vendor product collection.
 */
function _stripe_connect_marketplace_vendor_product_collection_access($permission = NULL) {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_product')) {
    return TRUE;
  }
  
  // Allow access for vendors with appropriate permission
  if ($account->hasRole('vendor') && ($permission === NULL || $account->hasPermission($permission))) {
    return TRUE;
  }
  
  return FALSE;
}

/**
 * Access callback for vendor product entity operations.
 */
function _stripe_connect_marketplace_vendor_product_entity_access($product, $operation = 'view') {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_product')) {
    return TRUE;
  }
  
  // For vendors, check if the product belongs to any of their stores
  if ($account->hasRole('vendor') && $account->hasPermission($operation . ' own commerce_product')) {
    $vendor_access = \Drupal::service('stripe_connect_marketplace.vendor_access');
    $user_store_ids = $vendor_access->getUserStoreIds($account->id());
    
    foreach ($product->getStores() as $store) {
      if (in_array($store->id(), $user_store_ids)) {
        return TRUE;
      }
    }
  }
  
  return FALSE;
}

/**
 * Access callback for vendor order collection.
 */
function _stripe_connect_marketplace_vendor_order_collection_access($permission = NULL) {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_order')) {
    return TRUE;
  }
  
  // Allow access for vendors with appropriate permission
  if ($account->hasRole('vendor') && ($permission === NULL || $account->hasPermission($permission))) {
    return TRUE;
  }
  
  return FALSE;
}

/**
 * Access callback for vendor add store form.
 */
function _stripe_connect_marketplace_vendor_add_store_access() {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_store')) {
    return TRUE;
  }
  
  // Allow access for vendors with create permission
  if ($account->hasRole('vendor') && $account->hasPermission('create commerce_store')) {
    return TRUE;
  }
  
  return FALSE;
}

/**
 * Access callback for vendor add product form.
 */
function _stripe_connect_marketplace_vendor_add_product_access() {
  $account = \Drupal::currentUser();
  
  // Allow access for admins
  if ($account->hasPermission('administer commerce_product')) {
    return TRUE;
  }
  
  // Allow access for vendors with create permission
  if ($account->hasRole('vendor') && $account->hasPermission('create commerce_product')) {
    // Check if vendor has at least one store
    $vendor_access = \Drupal::service('stripe_connect_marketplace.vendor_access');
    $user_store_ids = $vendor_access->getUserStoreIds($account->id());
    
    if (count($user_store_ids) > 0) {
      return TRUE;
    }
  }
  
  return FALSE;
}
